--// Ultimate Zombie Aimlock Script //--
--// Features: PC Keybind, Menu Toggle with X, Original Functionality, Auto-Fire Button //--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera
local player = Players.LocalPlayer

-- Kiểm tra xem GUI đã tồn tại chưa để tránh tạo nhiều lần
if game:GetService("CoreGui"):FindFirstChild("ZombieAimlockGUI") or player.PlayerGui:FindFirstChild("ZombieAimlockGUI") then
    return -- Nếu đã tồn tại thì không tạo lại
end

-- NEW: Robust GUI initialization (ONLY CHANGE MADE TO THE SCRIPT)
repeat task.wait() until player:IsDescendantOf(game) and player:FindFirstChild("PlayerGui")

local function createSafeGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ZombieAimlockGUI"
    screenGui.ResetOnSpawn = false
    
    -- 1st try: Standard PlayerGui
    local success = pcall(function()
        screenGui.Parent = player:WaitForChild("PlayerGui", 5)
    end)
    
    if not success then
        -- 2nd try: Exploit-specific methods
        pcall(function()
            if get_hidden_gui then
                screenGui.Parent = get_hidden_gui()
            elseif gethui then
                screenGui.Parent = gethui()
            elseif syn and syn.protect_gui then
                syn.protect_gui(screenGui)
                screenGui.Parent = game:GetService("CoreGui")
            else
                screenGui.Parent = game:GetService("CoreGui")
            end
        end)
    end
    return screenGui
end

local screenGui = createSafeGUI()

-- Config (ORIGINAL)
local aimPartName = "Head"
local zombiesFolder = workspace:WaitForChild("Zombies")
local isPC = false -- Will be set automatically
local aimbindKey = Enum.KeyCode.Q -- Default keybind
local waitingForKeybind = false

-- Auto-fire variables (NEW)
local autoFireActive = false
local fireMode = "Hold" -- "Click" or "Hold"
local clickDelay = 0.05 -- Delay between clicks in seconds
local holdDelay = 0.1 -- Delay before starting to hold in seconds
local lastFireTime = 0
local isHolding = false
local fireButton = nil
local fireButtonVisible = true

-- Original State (ORIGINAL)
local aimLockActive = false
local aimFOV = 150
local draggingSlider = false
local uiVisible = true
local fovVisible = true
local espVisible = false
local wallCheckEnabled = true
local hitboxEnabled = false

-- ESP storage (ORIGINAL)
local espObjects = {}

-- Detect platform (ORIGINAL)
isPC = UserInputService:GetPlatform() == Enum.Platform.Windows

----------------------------------------------------------------
-- FOV CIRCLE SYSTEM (ORIGINAL)
----------------------------------------------------------------
local fovCircle = Drawing.new("Circle")
fovCircle.Visible = fovVisible
fovCircle.Color = Color3.fromRGB(0, 170, 255)
fovCircle.Thickness = 2
fovCircle.NumSides = 64
fovCircle.Radius = aimFOV
fovCircle.Filled = false

local function updateFOVCircle()
    fovCircle.Radius = aimFOV
    fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    fovCircle.Visible = fovVisible
end

----------------------------------------------------------------
-- GUI SYSTEM (ORIGINAL with protected parent)
----------------------------------------------------------------
-- UI Toggle Button (with X key functionality) (ORIGINAL)
local toggleUIBtn = Instance.new("TextButton")
toggleUIBtn.Size = UDim2.new(0, 80, 0, 25)
toggleUIBtn.Position = UDim2.new(0, 10, 0, 10)
toggleUIBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
toggleUIBtn.TextColor3 = Color3.new(1,1,1)
toggleUIBtn.Text = "Hide UI [X]"
toggleUIBtn.Font = Enum.Font.Gotham
toggleUIBtn.TextSize = 12
toggleUIBtn.Parent = screenGui

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 4)
toggleCorner.Parent = toggleUIBtn

-- Main Frame (ORIGINAL)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, isPC and 470 or 440) -- Increased height for auto-fire settings
mainFrame.Position = UDim2.new(0.5, -120, 0.5, -(isPC and 235 or 220))
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Visible = uiVisible
mainFrame.Active = true
mainFrame.Draggable = true

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 6)
mainCorner.Parent = mainFrame

-- Title Bar (ORIGINAL)
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 28)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(1, -10, 1, 0)
titleText.Position = UDim2.new(0, 10, 0, 0)
titleText.BackgroundTransparency = 1
titleText.Text = "ZOMBIE AIMLOCK"
titleText.TextColor3 = Color3.new(1,1,1)
titleText.Font = Enum.Font.GothamBold
titleText.TextSize = 14
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Parent = titleBar

-- Content Frame (ORIGINAL)
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, -10, 1, -38)
contentFrame.Position = UDim2.new(0, 5, 0, 33)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- Add Keybind Option for PC (ORIGINAL)
if isPC then
    local keybindContainer = Instance.new("Frame")
    keybindContainer.Size = UDim2.new(1, 0, 0, 30)
    keybindContainer.Position = UDim2.new(0, 0, 0, 175)
    keybindContainer.BackgroundTransparency = 1
    keybindContainer.Parent = contentFrame

    local keybindLabel = Instance.new("TextLabel")
    keybindLabel.Size = UDim2.new(0.6, 0, 1, 0)
    keybindLabel.Position = UDim2.new(0, 0, 0, 0)
    keybindLabel.BackgroundTransparency = 1
    keybindLabel.Text = "Aimlock Key: " .. aimbindKey.Name
    keybindLabel.TextColor3 = Color3.new(1,1,1)
    keybindLabel.Font = Enum.Font.Gotham
    keybindLabel.TextSize = 13
    keybindLabel.TextXAlignment = Enum.TextXAlignment.Left
    keybindLabel.Parent = keybindContainer

    local keybindBtn = Instance.new("TextButton")
    keybindBtn.Size = UDim2.new(0.35, 0, 1, 0)
    keybindBtn.Position = UDim2.new(0.65, 0, 0, 0)
    keybindBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    keybindBtn.Text = "Change"
    keybindBtn.TextColor3 = Color3.new(1,1,1)
    keybindBtn.Font = Enum.Font.Gotham
    keybindBtn.TextSize = 13
    keybindBtn.Parent = keybindContainer

    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 4)
    btnCorner.Parent = keybindBtn

    keybindBtn.MouseButton1Click:Connect(function()
        waitingForKeybind = true
        keybindBtn.Text = "Press any key..."
    end)
end

-- Original Toggle Buttons (ORIGINAL)
local function CreateToggle(text, yPos, default, onColor, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 0, 30)
    btn.Position = UDim2.new(0, 0, 0, yPos)
    btn.BackgroundColor3 = default and onColor or Color3.fromRGB(70, 70, 90)
    btn.Text = text .. (default and ": ON" or ": OFF")
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 13
    btn.Parent = contentFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        local newState = not default
        default = newState
        btn.BackgroundColor3 = newState and onColor or Color3.fromRGB(70, 70, 90)
        btn.Text = text .. (newState and ": ON" or ": OFF")
        callback(newState)
    end)
end

-- Adjust yPos for PC version (ORIGINAL)
local yPos = isPC and 35 or 0
CreateToggle("AimLock", yPos, aimLockActive, Color3.fromRGB(0, 180, 80), function(s) aimLockActive = s end)
yPos = yPos + 35
CreateToggle("Auto Fire", yPos, autoFireActive, Color3.fromRGB(220, 50, 50), function(s) 
    autoFireActive = s 
    if fireButton then
        fireButton.Visible = fireButtonVisible and autoFireActive
    end
end)
yPos = yPos + 35
CreateToggle("FOV Circle", yPos, fovVisible, Color3.fromRGB(0, 120, 220), function(s) 
    fovVisible = s 
    updateFOVCircle()
end)
yPos = yPos + 35
CreateToggle("Zombie ESP", yPos, espVisible, Color3.fromRGB(220, 120, 0), function(s) 
    espVisible = s 
    updateESP() 
end)
yPos = yPos + 35
CreateToggle("Wall Check", yPos, wallCheckEnabled, Color3.fromRGB(0, 150, 150), function(s) wallCheckEnabled = s end)
yPos = yPos + 35
CreateToggle("Expand Hitbox", yPos, hitboxEnabled, Color3.fromRGB(160, 0, 160), function(s) 
    hitboxEnabled = s 
    updateAllZombies() 
end)

-- NEW: Fire Mode Selection
local fireModeContainer = Instance.new("Frame")
fireModeContainer.Size = UDim2.new(1, 0, 0, 30)
fireModeContainer.Position = UDim2.new(0, 0, 0, isPC and 245 or 215)
fireModeContainer.BackgroundTransparency = 1
fireModeContainer.Parent = contentFrame

local fireModeLabel = Instance.new("TextLabel")
fireModeLabel.Size = UDim2.new(1, 0, 0, 15)
fireModeLabel.Position = UDim2.new(0, 0, 0, 0)
fireModeLabel.BackgroundTransparency = 1
fireModeLabel.Text = "Fire Mode:"
fireModeLabel.TextColor3 = Color3.new(1,1,1)
fireModeLabel.Font = Enum.Font.Gotham
fireModeLabel.TextSize = 13
fireModeLabel.TextXAlignment = Enum.TextXAlignment.Left
fireModeLabel.Parent = fireModeContainer

local clickBtn = Instance.new("TextButton")
clickBtn.Size = UDim2.new(0.48, 0, 0, 25)
clickBtn.Position = UDim2.new(0, 0, 0, 15)
clickBtn.BackgroundColor3 = fireMode == "Click" and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
clickBtn.Text = "Click"
clickBtn.TextColor3 = Color3.new(1,1,1)
clickBtn.Font = Enum.Font.Gotham
clickBtn.TextSize = 13
clickBtn.Parent = fireModeContainer

local holdBtn = Instance.new("TextButton")
holdBtn.Size = UDim2.new(0.48, 0, 0, 25)
holdBtn.Position = UDim2.new(0.52, 0, 0, 15)
holdBtn.BackgroundColor3 = fireMode == "Hold" and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
holdBtn.Text = "Hold"
holdBtn.TextColor3 = Color3.new(1,1,1)
holdBtn.Font = Enum.Font.Gotham
holdBtn.TextSize = 13
holdBtn.Parent = fireModeContainer

clickBtn.MouseButton1Click:Connect(function()
    fireMode = "Click"
    clickBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    holdBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
end)

holdBtn.MouseButton1Click:Connect(function()
    fireMode = "Hold"
    clickBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    holdBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
end)

-- NEW: Click Delay Slider
local clickDelayContainer = Instance.new("Frame")
clickDelayContainer.Size = UDim2.new(1, 0, 0, 40)
clickDelayContainer.Position = UDim2.new(0, 0, 0, isPC and 280 or 250)
clickDelayContainer.BackgroundTransparency = 1
clickDelayContainer.Parent = contentFrame

local clickDelayLabel = Instance.new("TextLabel")
clickDelayLabel.Size = UDim2.new(1, 0, 0, 15)
clickDelayLabel.Position = UDim2.new(0, 0, 0, 0)
clickDelayLabel.BackgroundTransparency = 1
clickDelayLabel.Text = "Click Delay: " .. string.format("%.2f", clickDelay) .. "s"
clickDelayLabel.TextColor3 = Color3.new(1,1,1)
clickDelayLabel.Font = Enum.Font.Gotham
clickDelayLabel.TextSize = 13
clickDelayLabel.TextXAlignment = Enum.TextXAlignment.Left
clickDelayLabel.Parent = clickDelayContainer

local clickDelayTrack = Instance.new("Frame")
clickDelayTrack.Size = UDim2.new(1, 0, 0, 5)
clickDelayTrack.Position = UDim2.new(0, 0, 0, 20)
clickDelayTrack.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
clickDelayTrack.Parent = clickDelayContainer

local clickDelayFill = Instance.new("Frame")
clickDelayFill.Size = UDim2.new((clickDelay - 0.01)/0.2, 0, 1, 0)
clickDelayFill.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
clickDelayFill.Parent = clickDelayTrack

local clickDelayKnob = Instance.new("Frame")
clickDelayKnob.Size = UDim2.new(0, 12, 0, 12)
clickDelayKnob.Position = UDim2.new((clickDelay - 0.01)/0.2, -6, 0.5, -6)
clickDelayKnob.BackgroundColor3 = Color3.new(1,1,1)
clickDelayKnob.Parent = clickDelayTrack

local clickDelayKnobCorner = Instance.new("UICorner")
clickDelayKnobCorner.CornerRadius = UDim.new(1, 0)
clickDelayKnobCorner.Parent = clickDelayKnob

-- Click Delay Slider Functionality
local draggingClickDelay = false

local function updateClickDelaySlider()
    clickDelayFill.Size = UDim2.new((clickDelay - 0.01)/0.2, 0, 1, 0)
    clickDelayKnob.Position = UDim2.new((clickDelay - 0.01)/0.2, -6, 0.5, -6)
    clickDelayLabel.Text = "Click Delay: " .. string.format("%.2f", clickDelay) .. "s"
end

clickDelayTrack.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingClickDelay = true
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if draggingClickDelay and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mouseX = UserInputService:GetMouseLocation().X
        local sliderX = clickDelayTrack.AbsolutePosition.X
        local sliderWidth = clickDelayTrack.AbsoluteSize.X
        local relativeX = math.clamp(mouseX - sliderX, 0, sliderWidth)
        
        clickDelay = math.floor((0.01 + (relativeX/sliderWidth) * 0.2) * 100) / 100
        updateClickDelaySlider()
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingClickDelay = false
    end
end)

-- Original FOV Slider (ORIGINAL)
local sliderContainer = Instance.new("Frame")
sliderContainer.Size = UDim2.new(1, 0, 0, 40)
sliderContainer.Position = UDim2.new(0, 0, 0, isPC and 325 or 295)
sliderContainer.BackgroundTransparency = 1
sliderContainer.Parent = contentFrame

local sliderLabel = Instance.new("TextLabel")
sliderLabel.Size = UDim2.new(1, 0, 0, 15)
sliderLabel.Position = UDim2.new(0, 0, 0, 0)
sliderLabel.BackgroundTransparency = 1
sliderLabel.Text = "Aim FOV: " .. aimFOV
sliderLabel.TextColor3 = Color3.new(1,1,1)
sliderLabel.Font = Enum.Font.Gotham
sliderLabel.TextSize = 13
sliderLabel.TextXAlignment = Enum.TextXAlignment.Left
sliderLabel.Parent = sliderContainer

local sliderTrack = Instance.new("Frame")
sliderTrack.Size = UDim2.new(1, 0, 0, 5)
sliderTrack.Position = UDim2.new(0, 0, 0, 20)
sliderTrack.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
sliderTrack.Parent = sliderContainer

local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.new((aimFOV - 20)/280, 0, 1, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
sliderFill.Parent = sliderTrack

local sliderKnob = Instance.new("Frame")
sliderKnob.Size = UDim2.new(0, 12, 0, 12)
sliderKnob.Position = UDim2.new((aimFOV - 20)/280, -6, 0.5, -6)
sliderKnob.BackgroundColor3 = Color3.new(1,1,1)
sliderKnob.Parent = sliderTrack

local knobCorner = Instance.new("UICorner")
knobCorner.CornerRadius = UDim.new(1, 0)
knobCorner.Parent = sliderKnob

-- Sửa lỗi FOV slider không kéo được
local function updateFOVSlider()
    sliderFill.Size = UDim2.new((aimFOV - 20)/280, 0, 1, 0)
    sliderKnob.Position = UDim2.new((aimFOV - 20)/280, -6, 0.5, -6)
    sliderLabel.Text = "Aim FOV: " .. aimFOV
    updateFOVCircle()
end

sliderTrack.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingSlider = true
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if draggingSlider and input.UserInputType == Enum.UserInputType.MouseMovement then
        local mouseX = UserInputService:GetMouseLocation().X
        local sliderX = sliderTrack.AbsolutePosition.X
        local sliderWidth = sliderTrack.AbsoluteSize.X
        local relativeX = math.clamp(mouseX - sliderX, 0, sliderWidth)
        
        aimFOV = math.floor(20 + (relativeX/sliderWidth) * 280)
        updateFOVSlider()
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingSlider = false
    end
end)

-- Original Hitbox Selection (ORIGINAL)
local hitboxContainer = Instance.new("Frame")
hitboxContainer.Size = UDim2.new(1, 0, 0, 30)
hitboxContainer.Position = UDim2.new(0, 0, 0, isPC and 370 or 340)
hitboxContainer.BackgroundTransparency = 1
hitboxContainer.Parent = contentFrame

local hitboxLabel = Instance.new("TextLabel")
hitboxLabel.Size = UDim2.new(1, 0, 0, 15)
hitboxLabel.Position = UDim2.new(0, 0, 0, 0)
hitboxLabel.BackgroundTransparency = 1
hitboxLabel.Text = "Aim Part:"
hitboxLabel.TextColor3 = Color3.new(1,1,1)
hitboxLabel.Font = Enum.Font.Gotham
hitboxLabel.TextSize = 13
hitboxLabel.TextXAlignment = Enum.TextXAlignment.Left
hitboxLabel.Parent = hitboxContainer

local headBtn = Instance.new("TextButton")
headBtn.Size = UDim2.new(0.48, 0, 0, 25)
headBtn.Position = UDim2.new(0, 0, 0, 15)
headBtn.BackgroundColor3 = aimPartName == "Head" and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
headBtn.Text = "Head"
headBtn.TextColor3 = Color3.new(1,1,1)
headBtn.Font = Enum.Font.Gotham
headBtn.TextSize = 13
headBtn.Parent = hitboxContainer

local torsoBtn = Instance.new("TextButton")
torsoBtn.Size = UDim2.new(0.48, 0, 0, 25)
torsoBtn.Position = UDim2.new(0.52, 0, 0, 15)
torsoBtn.BackgroundColor3 = aimPartName == "HumanoidRootPart" and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
torsoBtn.Text = "Torso"
torsoBtn.TextColor3 = Color3.new(1,1,1)
torsoBtn.Font = Enum.Font.Gotham
torsoBtn.TextSize = 13
torsoBtn.Parent = hitboxContainer

headBtn.MouseButton1Click:Connect(function()
    aimPartName = "Head"
    headBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    torsoBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
end)

torsoBtn.MouseButton1Click:Connect(function()
    aimPartName = "HumanoidRootPart"
    headBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    torsoBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
end)

-- NEW: Add credit label at the bottom right corner
local creditLabel = Instance.new("TextLabel")
creditLabel.Size = UDim2.new(1, -10, 0, 15)
creditLabel.Position = UDim2.new(0, 5, 1, -15)
creditLabel.BackgroundTransparency = 1
creditLabel.Text = "Made By Jae"
creditLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
creditLabel.Font = Enum.Font.Gotham
creditLabel.TextSize = 11
creditLabel.TextXAlignment = Enum.TextXAlignment.Right
creditLabel.Parent = contentFrame

-- NEW: Create auto-fire button
fireButton = Instance.new("TextButton")
fireButton.Size = UDim2.new(0, 80, 0, 80)
fireButton.Position = UDim2.new(1, -90, 1, -90)
fireButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
fireButton.BackgroundTransparency = 0.5
fireButton.Text = "AUTO\nFIRE"
fireButton.TextColor3 = Color3.new(1, 1, 1)
fireButton.Font = Enum.Font.GothamBold
fireButton.TextSize = 16
fireButton.TextWrapped = true
fireButton.Visible = autoFireActive
fireButton.Parent = screenGui

local fireCorner = Instance.new("UICorner")
fireCorner.CornerRadius = UDim.new(1, 0)
fireCorner.Parent = fireButton

-- Make fire button draggable
fireButton.Active = true
fireButton.Draggable = true

-- UI Toggle Functionality (with X key support) (ORIGINAL)
toggleUIBtn.MouseButton1Click:Connect(function()
    uiVisible = not uiVisible
    mainFrame.Visible = uiVisible
    toggleUIBtn.Text = uiVisible and "Hide UI [X]" or "Show UI [X]"
end)

-- X Key Toggle (ORIGINAL)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.X then
        uiVisible = not uiVisible
        mainFrame.Visible = uiVisible
        toggleUIBtn.Text = uiVisible and "Hide UI [X]" or "Show UI [X]"
    end
    
    -- Keybind handling for PC (ORIGINAL)
    if isPC then
        if waitingForKeybind then
            if input.UserInputType == Enum.UserInputType.Keyboard then
                aimbindKey = input.KeyCode
                waitingForKeybind = false
                -- Update keybind display
                for _, v in pairs(screenGui:GetDescendants()) do
                    if v:IsA("TextLabel") and v.Text:find("Aimlock Key") then
                        v.Text = "Aimlock Key: " .. aimbindKey.Name
                    elseif v:IsA("TextButton") and v.Text == "Press any key..." then
                        v.Text = "Change"
                    end
                end
            end
        elseif input.KeyCode == aimbindKey then
            aimLockActive = not aimLockActive
            -- Update toggle display
            for _, v in pairs(screenGui:GetDescendants()) do
                if v:IsA("TextButton") and v.Text:find("AimLock") then
                    v.Text = "AimLock: " .. (aimLockActive and "ON" or "OFF")
                    v.BackgroundColor3 = aimLockActive and Color3.fromRGB(0, 180, 80) or Color3.fromRGB(70, 70, 90)
                end
            end
        end
    end
end)

----------------------------------------------------------------
-- ESP FUNCTIONS (MODIFIED - Ẩn tên zombie thường)
----------------------------------------------------------------
local function clearESP()
    for _, v in pairs(espObjects) do
        if v and v.Parent then
            v:Destroy()
        end
    end
    espObjects = {}
end

local function createESP(zombie)
    if zombie:IsA("Model") and not zombie:FindFirstChild("ESP_Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = zombie
        highlight.FillColor = Color3.new(1, 0, 0)
        highlight.OutlineColor = Color3.new(1, 0, 0)
        highlight.FillTransparency = 0.7
        highlight.OutlineTransparency = 0
        highlight.Parent = zombie
        
        -- Chỉ tạo nhãn tên nếu không phải là zombie thường
        if zombie.Name ~= "zombie" then
            local nameLabel = Instance.new("BillboardGui")
            nameLabel.Name = "ESP_Name"
            nameLabel.Adornee = zombie:FindFirstChild("Head") or zombie:FindFirstChild("HumanoidRootPart")
            nameLabel.Size = UDim2.new(0, 200, 0, 50)
            nameLabel.StudsOffset = Vector3.new(0, 2, 0)
            nameLabel.AlwaysOnTop = true
            nameLabel.Parent = zombie
            
            local textLabel = Instance.new("TextLabel")
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = zombie.Name
            textLabel.TextColor3 = Color3.new(1, 1, 1)
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
            textLabel.TextStrokeTransparency = 0
            textLabel.TextSize = 14
            textLabel.Font = Enum.Font.GothamBold
            textLabel.Parent = nameLabel
            
            table.insert(espObjects, nameLabel)
        end
        
        table.insert(espObjects, highlight)
    end
end

local function updateESP()
    clearESP()
    if espVisible then
        for _, z in ipairs(zombiesFolder:GetChildren()) do
            createESP(z)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(child)
    if espVisible then
        task.wait(0.1)
        createESP(child)
    end
end)

----------------------------------------------------------------
-- SPECIAL SNIPER ZOMBIE HANDLING (NEW)
----------------------------------------------------------------
local function isSniperZombie(zombie)
    -- Check if this is a sniper zombie by name or other characteristics
    return zombie.Name:lower():find("sniper") or zombie.Name:lower():find("shooter")
end

local function getSniperZombieRealPosition(zombie)
    -- Try to find the actual position of the sniper zombie
    -- This is a workaround for the visual bug where it appears stuck at spawn
    
    -- Method 1: Check if there's a humanoid root part that might have the real position
    local rootPart = zombie:FindFirstChild("HumanoidRootPart")
    if rootPart and (rootPart.Position - zombie:GetPivot().Position).Magnitude > 5 then
        return rootPart.Position
    end
    
    -- Method 2: Check for any moving parts
    for _, part in ipairs(zombie:GetChildren()) do
        if part:IsA("BasePart") and part.Velocity.Magnitude > 0 then
            return part.Position
        end
    end
    
    -- Method 3: If all else fails, try to find the zombie by raycasting
    local character = player.Character
    if character then
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            -- Raycast to find zombies in the direction the player is facing
            local rayOrigin = humanoidRootPart.Position
            local rayDirection = (humanoidRootPart.CFrame.LookVector * 100)
            local raycastParams = RaycastParams.new()
            raycastParams.FilterDescendantsInstances = {character}
            raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
            raycastParams.IgnoreWater = true
            
            local result = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
            if result and result.Instance then
                local hitZombie = result.Instance:FindFirstAncestorOfClass("Model")
                if hitZombie == zombie then
                    return result.Position
                end
            end
        end
    end
    
    -- Fallback: Return the visual position
    return zombie:GetPivot().Position
end

----------------------------------------------------------------
-- AIMBOT FUNCTIONS (MODIFIED - Special handling for sniper zombies)
----------------------------------------------------------------
local function getClosestZombieInFOV()
    local closestZombie = nil
    local closestDistance = math.huge
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        -- Bỏ qua zombie có tên "SwampGiant"
        if zombie:IsA("Model") and zombie.Name ~= "SwampGiant" then
            local part = zombie:FindFirstChild(aimPartName)
            if part then
                -- Special handling for sniper zombies with visual bugs
                local targetPosition = part.Position
                if isSniperZombie(zombie) then
                    targetPosition = getSniperZombieRealPosition(zombie)
                end
                
                local screenPos, onScreen = camera:WorldToViewportPoint(targetPosition)
                
                if onScreen then
                    local screenDistance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                    local worldDistance = (targetPosition - camera.CFrame.Position).Magnitude
                    
                    if screenDistance <= aimFOV and worldDistance < closestDistance then
                        local visible = true
                        if wallCheckEnabled then
                            local raycastParams = RaycastParams.new()
                            raycastParams.FilterDescendantsInstances = {player.Character, camera}
                            raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
                            raycastParams.IgnoreWater = true
                            
                            local rayDirection = (targetPosition - camera.CFrame.Position)
                            local result = workspace:Raycast(
                                camera.CFrame.Position,
                                rayDirection.Unit * rayDirection.Magnitude,
                                raycastParams
                            )
                            
                            if result then
                                local hitPart = result.Instance
                                visible = hitPart and (hitPart:IsDescendantOf(zombie) or hitPart == part)
                            end
                        end
                        
                        if visible then
                            closestDistance = worldDistance
                            closestZombie = zombie
                        end
                    end
                end
            end
        end
    end
    
    return closestZombie
end

----------------------------------------------------------------
-- HITBOX FUNCTIONS (MODIFIED - Special handling for sniper zombies)
----------------------------------------------------------------
local function expandHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if not head:FindFirstChild("OriginalSize") then
                local originalSize = Instance.new("Vector3Value")
                originalSize.Name = "OriginalSize"
                originalSize.Value = head.Size
                originalSize.Parent = head
            end
            
            -- Special hitbox for sniper zombies (5x5x5 as requested for testing)
            if isSniperZombie(zombie) then
                head.Size = Vector3.new(5, 5, 5)  -- 5x5x5 for sniper zombies
            else
                head.Size = Vector3.new(5, 5, 5)  -- Same size for other zombies
            end
            
            head.CanCollide = false
            head.Material = Enum.Material.ForceField
        end
    end
end

local function resetHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if head:FindFirstChild("OriginalSize") then
                head.Size = head.OriginalSize.Value
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
                head.OriginalSize:Destroy()
            else
                head.Size = Vector3.new(1, 1, 1)
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
            end
        end
    end
end

local function updateAllZombies()
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if hitboxEnabled then
            expandHeadHitbox(zombie)
        else
            resetHeadHitbox(zombie)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(zombie)
    task.wait(0.2)
    if hitboxEnabled then
        expandHeadHitbox(zombie)
    end
end)

-- Initialize hitboxes
updateAllZombies()

----------------------------------------------------------------
-- AUTO-FIRE FUNCTIONS (NEW)
----------------------------------------------------------------
local function isTargetInCrosshair()
    if not aimLockActive then return false end
    
    local targetZombie = getClosestZombieInFOV()
    if not targetZombie then return false end
    
    local targetPart = targetZombie:FindFirstChild(aimPartName)
    if not targetPart then return false end
    
    -- Check if target is within a small radius of the crosshair center
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    local screenPos = camera:WorldToViewportPoint(targetPart.Position)
    local screenDistance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
    
    -- Consider target in crosshair if it's within 10 pixels of center
    return screenDistance <= 10
end

local function fireWeapon()
    -- Simulate mouse click to fire weapon
    local mouse = player:GetMouse()
    if fireMode == "Click" then
        mouse.Button1Down:Fire()
        task.wait(0.05)
        mouse.Button1Up:Fire()
    else -- Hold mode
        if not isHolding then
            mouse.Button1Down:Fire()
            isHolding = true
        end
    end
end

local function stopFiring()
    if isHolding then
        local mouse = player:GetMouse()
        mouse.Button1Up:Fire()
        isHolding = false
    end
end

local function handleAutoFire()
    if autoFireActive and aimLockActive then
        local currentTime = tick()
        
        if isTargetInCrosshair() then
            if fireMode == "Click" then
                if currentTime - lastFireTime >= clickDelay then
                    fireWeapon()
                    lastFireTime = currentTime
                end
            else -- Hold mode
                if not isHolding then
                    if currentTime - lastFireTime >= holdDelay then
                        fireWeapon()
                        lastFireTime = currentTime
                    end
                end
            end
        else
            stopFiring()
        end
    else
        stopFiring()
    end
end

----------------------------------------------------------------
-- MAIN LOOP (MODIFIED - Special targeting for sniper zombies)
----------------------------------------------------------------
RunService.RenderStepped:Connect(function()
    -- Update FOV circle position and size
    updateFOVCircle()
    
    -- Handle auto-fire
    handleAutoFire()
    
    -- Aimlock logic
    if aimLockActive then
        local targetZombie = getClosestZombieInFOV()
        if targetZombie then
            local targetPart = targetZombie[aimPartName]
            if targetPart then
                -- Special handling for sniper zombies
                local targetPosition = targetPart.Position
                if isSniperZombie(targetZombie) then
                    targetPosition = getSniperZombieRealPosition(targetZombie)
                end
                
                camera.CFrame = CFrame.new(camera.CFrame.Position, targetPosition)
            end
        end
    end
end)
