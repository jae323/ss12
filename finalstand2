--// Ultimate Zombie Aimlock Script //--
--// Features: Version Selection, Main Gui, and SniperZombie Aimbot Version //--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera
local player = Players.LocalPlayer

-- Kiểm tra xem GUI đã tồn tại chưa để tránh tạo nhiều lần
if game:GetService("CoreGui"):FindFirstChild("ZombieAimlockGUI") or player.PlayerGui:FindFirstChild("ZombieAimlockGUI") then
    return -- Nếu đã tồn tại thì không tạo lại
end

-- NEW: Robust GUI initialization
repeat task.wait() until player:IsDescendantOf(game) and player:FindFirstChild("PlayerGui")

local function createSafeGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ZombieAimlockGUI"
    screenGui.ResetOnSpawn = false
    
    -- 1st try: Standard PlayerGui
    local success = pcall(function()
        screenGui.Parent = player:WaitForChild("PlayerGui", 5)
    end)
    
    if not success then
        -- 2nd try: Exploit-specific methods
        pcall(function()
            if get_hidden_gui then
                screenGui.Parent = get_hidden_gui()
            elseif gethui then
                screenGui.Parent = gethui()
            elseif syn and syn.protect_gui then
                syn.protect_gui(screenGui)
                screenGui.Parent = game:GetService("CoreGui")
            else
                screenGui.Parent = game:GetService("CoreGui")
            end
        end)
    end
    return screenGui
end

local screenGui = createSafeGUI()

-- Biến toàn cục để xác định phiên bản đang chạy
local currentVersion = "Main" -- "Main" hoặc "SniperAimbot"

-- Config (ORIGINAL)
local aimPartName = "Head"
local zombiesFolder = workspace:WaitForChild("Zombies")
local isPC = false -- Will be set automatically
local aimbindKey = Enum.KeyCode.Q -- Default keybind
local waitingForKeybind = false

-- Original State (ORIGINAL)
local aimLockActive = false
local aimFOV = 150 -- FOV value is still used internally
local uiVisible = true
local espVisible = false
local wallCheckEnabled = true
local hitboxEnabled = false

-- NEW: Smooth Aim Settings
local smoothAimEnabled = false

-- ESP storage (ORIGINAL)
local espObjects = {}

-- Detect platform (ORIGINAL)
isPC = UserInputService:GetPlatform() == Enum.Platform.Windows

----------------------------------------------------------------
-- GUI SYSTEM (ORIGINAL with protected parent)
----------------------------------------------------------------
local mainFrame, toggleUIBtn

local function initializeMainGUI()
    -- UI Toggle Button (with X key functionality) (ORIGINAL)
    toggleUIBtn = Instance.new("TextButton")
    toggleUIBtn.Size = UDim2.new(0, 80, 0, 25)
    toggleUIBtn.Position = UDim2.new(0, 10, 0, 10)
    toggleUIBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
    toggleUIBtn.TextColor3 = Color3.new(1,1,1)
    toggleUIBtn.Text = "Hide UI [X]"
    toggleUIBtn.Font = Enum.Font.Gotham
    toggleUIBtn.TextSize = 12
    toggleUIBtn.Parent = screenGui

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 4)
    toggleCorner.Parent = toggleUIBtn

    -- Main Frame (ORIGINAL) - Reduced height since FOV slider is removed
    mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 240, 0, isPC and 300 or 270)
    mainFrame.Position = UDim2.new(0.5, -120, 0.5, -(isPC and 150 or 135))
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    mainFrame.Visible = uiVisible
    mainFrame.Active = true
    mainFrame.Draggable = true

    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = mainFrame

    -- Title Bar (ORIGINAL)
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 28)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame

    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, -10, 1, 0)
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = currentVersion == "Main" and "ZOMBIE AIMLOCK" or "SNIPER AIMBOT"
    titleText.TextColor3 = Color3.new(1,1,1)
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 14
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar

    -- Content Frame (ORIGINAL)
    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, -10, 1, -38)
    contentFrame.Position = UDim2.new(0, 5, 0, 33)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = mainFrame

    -- Add Keybind Option for PC (ORIGINAL)
    if isPC then
        local keybindContainer = Instance.new("Frame")
        keybindContainer.Size = UDim2.new(1, 0, 0, 30)
        keybindContainer.Position = UDim2.new(0, 0, 0, 175)
        keybindContainer.BackgroundTransparency = 1
        keybindContainer.Parent = contentFrame

        local keybindLabel = Instance.new("TextLabel")
        keybindLabel.Size = UDim2.new(0.6, 0, 1, 0)
        keybindLabel.Position = UDim2.new(0, 0, 0, 0)
        keybindLabel.BackgroundTransparency = 1
        keybindLabel.Text = "Aimlock Key: " .. aimbindKey.Name
        keybindLabel.TextColor3 = Color3.new(1,1,1)
        keybindLabel.Font = Enum.Font.Gotham
        keybindLabel.TextSize = 13
       极indLabel.TextXAlignment = Enum.TextXAlignment.Left
        keybindLabel.Parent = keybindContainer

        local keybindBtn = Instance.new("TextButton")
        keybindBtn.Size = UDim2.new(0.35, 0, 1, 0)
        keybindBtn.Position = UDim2.new(0.65, 0, 0, 0)
        keybindBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
        keybindBtn.Text = "Change"
        keybindBtn.TextColor3 = Color3.new(1,1,1)
        keybindBtn.Font = Enum.Font.Gotham
        keybindBtn.TextSize = 13
        keybindBtn.Parent极indContainer

        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = keybindBtn

        keybindBtn.MouseButton1Click:Connect(function()
            waitingForKeybind = true
            keybindBtn.Text = "Press any key..."
        end)
    end

    -- Original Toggle Buttons (ORIGINAL)
    local function CreateToggle(text, yPos, default, onColor, callback)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, 0, 0, 30)
        btn.Position = UDim2.new(0, 极, 0, yPos)
        btn.BackgroundColor3 = default and onColor or Color3.fromRGB(70, 70, 90)
        btn.Text = text .. (default and ": ON" or ": OFF")
        btn.TextColor3 = Color3.new(1,1,1)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 13
        btn.Parent = contentFrame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = btn
        
        btn.MouseButton1Click:极nect(function()
            local newState = not default
            default = newState
            btn.BackgroundColor3 = newState and onColor or Color3.fromRGB(70, 70, 90)
            btn.Text = text .. (newState and ": ON" or ": OFF")
            callback(newState)
        end)
        
        return btn
    end

    -- Adjust yPos for PC version (ORIGINAL)
    local yPos = isPC and 35 or 0

    -- MODIFIED: Add [E] to the AimLock text to indicate the keybind
    local aimlockBtn = CreateToggle("AimLock [E]", yPos, aimLockActive, Color3.fromRGB(0, 180, 80), function(s) 
        aimLockActive = s 
    end)
    yPos = yPos + 35
    
    -- NEW: Smooth Aim Toggle
    local smoothAimBtn = CreateToggle("Smooth Aim", yPos, smoothAimEnabled, Color3.fromRGB(120, 0, 200), function(s) 
        smoothAimEnabled = s 
    end)
    yPos = yPos + 35
    
    local espBtn = CreateToggle("Zombie ESP", yPos, espVisible, Color3.fromRGB(220, 120, 0), function(s) 
        espVisible = s 
        updateESP() 
    end)
    yPos = yPos + 35
    
    local wallCheckBtn = CreateToggle("Wall Check", yPos, wallCheckEnabled, Color3.fromRGB(0, 150, 150), function(s) 
        wallCheckEnabled = s 
    end)
    yPos = yPos + 35
    
    local hitboxBtn = CreateToggle("Expand Hitbox", yPos, hitboxEnabled, Color3.fromRGB(160, 0, 160), function(s) 
        hitboxEnabled = s 
        updateAllZombies() 
    end)

    -- Original Hitbox Selection (ORIGINAL) - Moved up since FOV slider is removed
    local hitboxContainer = Instance.new("Frame")
    hitboxContainer.Size = UDim2.new(1, 0, 0, 30)
    hitboxContainer.Position = UDim2.new(0, 0, 0, isPC and 210 or 180)
    hitboxContainer.BackgroundTransparency = 1
    hitboxContainer.Parent = contentFrame

    local hitboxLabel = Instance.new("TextLabel")
    hitboxLabel.Size = UDim2.new(1, 0, 0, 15)
    hitboxLabel.Position = UDim2.new(0, 0, 0, 0)
    hitboxLabel.BackgroundTransparency = 1
    hitboxLabel.Text = "Aim Part:"
    hitboxLabel.Text极or3 = Color3.new(1,1,1)
    hitboxLabel.Font = Enum.Font.Gotham
    hitboxLabel.TextSize = 13
    hitboxLabel.TextXAlignment = Enum.TextXAlignment.Left
    hitboxLabel.Parent = hitboxContainer

    local headBtn = Instance.new("TextButton")
    headBtn.Size = UDim2.new(0.48, 0, 0, 25)
    headBtn.Position = UDim2.new(0, 0, 0, 15)
    headBtn.BackgroundColor3 = aimPartName == "Head" and Color3.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
    headBtn.Text = "Head"
    headBtn.TextColor3 = Color3.new(1,1,1)
    headBtn.Font = Enum.Font.Gotham
    headBtn.TextSize = 13
    headBtn.Parent = hitboxContainer

    local torsoBtn = Instance.new("TextButton")
    torsoBtn.Size = UDim2.new(0.48, 极, 0, 25)
    torsoBtn.Position = UDim2.new(0.52, 0, 0, 15)
    torsoBtn.BackgroundColor3 = aimPartName == "HumanoidRootPart" and Color极.fromRGB(0, 170, 255) or Color3.fromRGB(70, 70, 90)
    torsoBtn.Text = "Torso"
    torsoBtn.TextColor3 = Color3.new(1,1,1)
    torsoBtn.Font = Enum.Font.Gotham
    torsoBtn.TextSize = 13
    torsoBtn.Parent = hitboxContainer

    headBtn.MouseButton1Click:Connect(function()
        aimPartName = "Head"
        headBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        torsoBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    end)

    torsoBtn.MouseButton1Click:Connect(function()
        aimPartName = "HumanoidRootPart"
        headBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
        torsoBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    end)

    -- NEW: Add credit label at the bottom right corner
    local creditLabel = Instance.new("TextLabel")
    creditLabel.Size = UDim2.new(1, -10, 0, 15)
    creditLabel.Position = UDim2.new(0, 5, 1, -15)
    creditLabel.BackgroundTransparency = 1
    creditLabel.Text = "Made By Jae"
    creditLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    creditLabel.Font = Enum.Font.Gotham
    creditLabel.TextSize = 11
    creditLabel.TextXAlignment = Enum.TextXAlignment.Right
    creditLabel.Parent = contentFrame

    -- UI Toggle Functionality (with X key support) (ORIGINAL)
    toggleUIBtn.MouseButton1Click:Connect(function()
        uiVisible = not uiVisible
        mainFrame.Visible = uiVisible
        toggleUIBtn.Text = uiVisible and "Hide UI [X]" or "Show UI [X]"
    end)

    -- X Key Toggle (ORIGINAL)
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.X then
            uiVisible = not uiVisible
            mainFrame.Visible = uiVisible
            toggleU极.Text = uiVisible and "Hide UI [X]" or "Show UI [X]"
        end
        
        -- NEW: E Key Toggle for Aimlock
        if not gameProcessed and input.KeyCode == Enum.KeyCode.E then
            aimLockActive = not aimLockActive
            aimlockBtn.Text = "AimLock [E]: " .. (aimLockActive and "ON" or "OFF")
            aimlockBtn.BackgroundColor3 = aimLockActive and Color3.fromRGB(0, 180, 80) or Color3.fromRGB(70, 70, 90)
        end
        
        -- Keybind handling for PC (ORIGINAL)
        if isPC then
            if waitingForKeybind then
                if input.UserInputType == Enum.UserInputType.Keyboard then
                    aimbindKey = input.KeyCode
                    waitingForKeybind = false
                    -- Update keybind display
                    for _, v in pairs(contentFrame:GetChildren()) do
                        if v:IsA("TextLabel") and v.Text:find("Aimlock Key") then
                            v.Text = "Aimlock Key: " .. aimbindKey.Name
                        elseif v:IsA("TextButton") and v.Text == "Press any key..." then
                            v.Text = "Change"
                        end
                    end
                end
            elseif input.KeyCode == aimbindKey then
                aimLockActive = not aimLockActive
                aimlockBtn.Text = "AimLock [E]: " .. (aimLockActive and "ON" or "OFF")
                aimlockBtn.BackgroundColor3 = aimLockActive and Color3.fromRGB(0, 极, 80) or Color3.fromRGB(70, 70, 90)
            end
        end
    end)
end

-- Tạo GUI lựa chọn phiên bản phía dưới GUI chính
local function createVersionSelectionGUI()
    local versionFrame = Instance.new("Frame")
    versionFrame.Size = UDim2.new(0, 240, 0, 50)
    versionFrame.Position = UDim2.new(0.5, -120, 0.5, 100)
    versionFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    versionFrame.BorderSizePixel = 0
    versionFrame.Parent = screenGui
    versionFrame.Visible = true
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = versionFrame
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 20)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    title.BorderSizePixel = 0
    title.Text = "SELECT VERSION"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 12
    title.Parent = versionFrame
    
    local titleCorner = Instance.new("UICorner")
    title极rner.CornerRadius = UDim.new(0, 6)
    titleCorner.Parent = title
    
    local mainBtn = Instance.new("TextButton")
    mainBtn.Size = UDim2.new(0.45, 0, 0, 25)
    mainBtn.Position = UDim2.new(0.025, 0, 0, 22)
    mainBtn.BackgroundColor3 = currentVersion == "Main" and Color3.fromRGB(0, 120, 220) or Color3.fromRGB(70, 70, 90)
    mainBtn.Text = "Main Gui"
    mainBtn.TextColor3 = Color3.new(1, 1, 1)
    mainBtn.Font = Enum.Font.Gotham
    mainBtn.TextSize = 12
    mainBtn.Parent = versionFrame
    
    local sniperBtn = Instance.new("TextButton")
    sniperBtn.Size = UDim2.new(0.45, 0, 0, 极)
    sniperBtn.Position = UDim2.new(0.525, 0, 0, 22)
    sniperBtn.BackgroundColor极 = currentVersion == "SniperAimbot" and Color3.fromRGB(220, 120, 0) or Color3.fromRGB(70, 70, 90)
    sniperBtn.Text = "Sniper Aimbot"
    sniperBtn.TextColor3 = Color3.new(1, 1, 1)
    sniperBtn.Font = Enum.Font.Gotham
    sniperBtn.TextSize = 12
    sniperBtn.Parent = versionFrame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 4)
    btnCorner.Parent = mainBtn
    btnCorner:Clone().Parent = sniperBtn
    
    -- Xử lý sự kiện khi chọn phiên bản
    mainBtn.MouseButton1Click:Connect(function()
        currentVersion = "Main"
        mainBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 220)
        sniperBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
        
        -- Cập nhật tiêu đề
        if mainFrame and mainFrame:FindFirstChild("TitleBar") then
            local titleText = mainFrame.TitleBar:FindFirstChildOfClass("TextLabel")
            if titleText then
                titleText.Text = "ZOMBIE AIMLOCK"
            end
        end
    end)
    
    sniperBtn.MouseButton1Click:Connect(function()
        currentVersion = "S极erAimbot"
        sniperBtn.BackgroundColor3 = Color3.fromRGB(220, 120, 0)
        mainBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
        
        -- Cập nhật tiêu đề
        if mainFrame and mainFrame:FindFirstChild("TitleBar") then
            local titleText = mainFrame.TitleBar:FindFirstChildOfClass("TextLabel")
            if titleText then
                titleText.Text = "SNIPER AIMBOT"
            end
        end
    end)
    
    -- Nút Show/Hide cho GUI phiên bản
    local showVersionBtn = Instance.new("TextButton")
    showVersionBtn.Size = UDim2.new(0, 100, 0, 25)
    showVersionBtn.Position = UDim2.new(0, 10, 0, 40)
    showVersionBtn.BackgroundColor3 = Color3.from极(45, 45, 60)
    showVersionBtn.TextColor3 = Color3.new(1,1,1)
    showVersionBtn.Text = "Show Version"
    showVersionBtn.Font = Enum.Font.Gotham
    showVersionBtn.TextSize = 12
    showVersionBtn.Parent = screenGui
    
    local showVersionCorner = Instance.new("UICorner")
    showVersionCorner.CornerRadius = UDim.new(0, 4)
    showVersionCorner.Parent = showVersionBtn
    
    local versionVisible = true
    showVersionBtn.MouseButton1Click:Connect(function()
        versionVisible = not versionVisible
        versionFrame.Visible = versionVisible
        showVersionBtn.Text = versionVisible and "Hide Version" or "Show Version"
    end)
end

----------------------------------------------------------------
-- ESP FUNCTIONS (MODIFIED - Ẩn tên zombie thường)
----------------------------------------------------------------
local function clearESP()
    for _, v in pairs(espObjects) do
        if v and v.Parent then
            v:Destroy()
        end
    end
    espObjects = {}
end

local function createESP(zombie)
    if zombie:IsA("Model") and not zombie:FindFirstChild("ESP_Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = zombie
        highlight.FillColor = Color3.new(1, 0, 0)
        highlight.OutlineColor = Color3.new(1, 0, 0)
        highlight.FillTransparency = 0.7
        highlight.OutlineTransparency = 0
        highlight.Parent = zombie
        
        -- Chỉ tạo nhãn tên nếu không phải là zombie thường
        if zombie.Name ~= "zombie" then
            local nameLabel = Instance.new("BillboardGui")
            nameLabel.Name = "ESP_Name"
            nameLabel.Adornee = zombie:FindFirstChild("Head") or zombie:FindFirstChild("HumanoidRootPart")
            nameLabel.Size = UDim2.new(0, 200, 0, 50)
            nameLabel.StudsOffset = Vector3.new(0, 2, 0)
            nameLabel.AlwaysOnTop =极e
            nameLabel.Parent = zombie
            
            local textLabel = Instance.new("TextLabel")
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = zombie.Name
            textLabel.TextColor3 = Color3.new(1, 1, 1)
            textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
            textLabel.TextStrokeTransparency = 0
            textLabel.TextSize = 14
            textLabel.Font = Enum.Font.GothamBold
            textLabel.Parent = nameLabel
            
            table.insert(espObjects, nameLabel)
        end
        
        table.insert(espObjects, highlight)
    end
end

local function updateESP()
    clearESP()
    if espVisible then
        for _, z in ipairs(zombiesFolder:GetChildren()) do
            createESP(z)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(child)
    if espVisible then
        task.wait(0.1)
        createESP(child)
    end
end)

----------------------------------------------------------------
-- SPECIAL SNIPER ZOMBIE HANDLING (NEW)
----------------------------------------------------------------
local function isSniperZombie(zombie)
    -- Check if this is a sniper zombie by name or other characteristics
    return zombie.Name:lower():find("sniper") or zombie.Name:lower():find("shooter")
end

local function getSniperZombieRealPosition(zombie)
    -- Try to find the actual position of the sniper zombie
    -- This is a workaround for the visual bug where it appears stuck at spawn
    
    -- Method 1: Check if there's a humanoid root part that might have the real position
    local rootPart = zombie:FindFirstChild("HumanoidRootPart")
    if rootPart and (rootPart.Position - zombie:GetPivot().Position).Magnitude > 5 then
        return rootPart.Position
    end
    
    -- Method 2: Check for any moving parts
    for _, part in ipairs(zombie:GetChildren()) do
        if part:IsA("BasePart") and part.Velocity.Magnitude > 0 then
            return part.Position
        end
    end
    
    -- Method 3: If all else fails, try to find the zombie by raycasting
    local character = player.Character
    if character then
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            -- Raycast to find zombies in the direction the player is facing
            local rayOrigin = humanoidRootPart.Position
            local rayDirection = (humanoidRootPart.CFrame.LookVector * 100)
            local raycastParams = RaycastParams.new()
            raycastParams.FilterDescendantsInstances = {character}
            raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
            raycastParams.IgnoreWater = true
            
            local result = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
            if result and result.Instance then
                local hitZombie = result.Instance:FindFirstAncestorOfClass("Model")
                if hitZomb极 == zombie then
                    return result.Position
                end
            end
        end
    end
    
    -- Fallback: Return the visual position
    return zombie:GetPivot().Position
end

----------------------------------------------------------------
-- SMOOTH AIM FUNCTION (NEW)
----------------------------------------------------------------
local function smoothAim(targetPosition)
    local currentCFrame = camera.CFrame
    local targetCFrame = CFrame.new(currentCFrame.Position, targetPosition)
    
    -- Calculate the smooth transition with a fixed smoothness factor
    local smoothFactor = 0.15 -- Fixed smoothness value
    local newCFrame = currentCFrame:Lerp(targetCFrame, smoothFactor)
    
    return new极rame
end

----------------------------------------------------------------
-- AIMBOT FUNCTIONS (MODIFIED - Special handling for sniper zombies)
----------------------------------------------------------------
local function getClosestZombieInFOV()
    local closestZombie = nil
    local closestDistance = math.huge
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        -- Bỏ qua zombie có tên "SwampGiant"
        if zombie:IsA("Model") and zombie.Name ~= "SwampGiant" then
            local part = zombie:FindFirstChild(aimPartName)
            if part then
                -- Special handling for sniper zombies with visual bugs
                local targetPosition = part.Position
                if isSniperZombie(zombie) then
                    targetPosition = getSniperZombieRealPosition(zombie)
                end
                
                local screenPos, onScreen = camera:WorldToViewportPoint(targetPosition)
                
                if onScreen then
                    local screenDistance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                    local worldDistance = (targetPosition - camera.CFrame.Position).Magnitude
                    
                    if screenDistance <= aimFOV and worldDistance < closestDistance then
                        -- MODIFIED: In SniperAimbot version, only target SniperZombies
                        if currentVersion == "SniperAimbot" and not isSniperZombie(zombie) then
                            -- Skip non-sniper zombies in SniperAimbot mode
                        else
                            local visible = true
                            if wallCheckEnabled then
                                local raycastParams = RaycastParams.new()
                                raycastParams.FilterDescendantsInstances = {player.Character, camera}
                                raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
                                raycastParams.IgnoreWater = true
                                
                                local rayDirection = (targetPosition - camera.CFrame.Position)
                                local result = workspace:Raycast(
                                    camera.CFrame.Position,
                                    rayDirection.Unit * rayDirection.Magnitude,
                                    raycastParams
                                )
                                
                                if result then
                                    local hitPart = result.Instance
                                    visible = hitPart and (hitPart:IsDescendantOf(zombie) or hitPart == part)
                                end
                            end
                            
                            if visible then
                                closestDistance = worldDistance
                                closestZombie = zombie
                            end
                        end
                    end
                end
            end
        end
    end
    
    return closestZombie
end

----------------------------------------------------------------
-- HITBOX FUNCTIONS (MODIFIED - Special handling for sniper zombies)
----------------------------------------------------------------
local function expandHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if not head:FindFirstChild("OriginalSize") then
                local originalSize = Instance.new("Vector3Value")
                originalSize.Name = "OriginalSize"
                originalSize.Value = head.Size
                originalSize.Parent = head
            end
            
            -- Special hitbox for sniper zombies (4极4x4 as requested)
            if isSniperZombie(zombie) then
                head.Size = Vector3.new(4, 4, 4)  -- 4x4x4 for sniper zombies
            else
                head.Size = Vector3.new(5, 5, 5)  -- Regular size for other zombies
            end
            
            head.CanCollide = false
            head.Material = Enum.Material.ForceField
        end
    end
end

local function resetHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if head:FindFirstChild("OriginalSize") then
                head.Size = head.OriginalSize.Value
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
                head.OriginalSize:Destroy()
            else
                head.Size = Vector3.new(1, 1, 1)
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
            end
        end
    end
end

local function updateAllZombies()
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if hitboxEnabled then
            expandHeadHitbox(zombie)
        else
            resetHeadHitbox(zombie)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(zombie)
    task.wait(0.2)
   极 hitboxEnabled then
        expandHeadHitbox(zombie)
    end
end)

-- Initialize hitboxes
updateAllZombies()

----------------------------------------------------------------
-- MAIN LOOP (MODIFIED - Special targeting for sniper zombies)
----------------------------------------------------------------
RunService.RenderStepped:Connect(function()
    -- Aimlock logic
    if aimLockActive then
        local targetZombie = getClosestZombieInFOV()
        if targetZombie then
            local targetPart = targetZombie[aimPartName]
            if targetPart then
                -- Special handling for sniper zombies
                local targetPosition = targetPart.Position
                if isSniperZombie(targetZombie) then
                    targetPosition = getSniperZombieRealPosition(targetZombie)
                end
                
                -- Apply smooth aim if enabled
                if smoothAimEnabled then
                    camera.CFrame = smoothAim(targetPosition)
                else
                    camera.CFrame = CFrame.new(camera.CFrame.Position, targetPosition)
                end
            end
        end
    end
end)

-- Khởi tạo GUI chính và GUI lựa chọn phiên bản
initializeMainGUI()
createVersionSelectionGUI()
